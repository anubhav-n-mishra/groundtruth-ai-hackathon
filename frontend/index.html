<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Insight Engine</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        header p { color: #a0a0a0; font-size: 1.1rem; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
        .card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card h2 { font-size: 1.4rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        .tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        .tab:hover { background: rgba(255, 255, 255, 0.2); }
        .tab.active { background: linear-gradient(135deg, #00d4ff, #7b2cbf); color: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        .upload-area:hover { border-color: #00d4ff; background: rgba(0, 212, 255, 0.1); }
        .upload-area .upload-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .upload-area p { color: #a0a0a0; margin-bottom: 5px; font-size: 0.9rem; }
        .upload-area .file-name { color: #00d4ff; font-weight: 600; margin-top: 8px; }
        input[type="file"] { display: none; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; color: #a0a0a0; font-size: 0.9rem; }
        .form-control {
            width: 100%;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 0.95rem;
        }
        .form-control:focus { outline: none; border-color: #00d4ff; }
        .form-control::placeholder { color: #666; }
        textarea.form-control { resize: vertical; font-family: 'Consolas', monospace; }

        .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto; padding: 5px; }
        .checkbox-item {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .checkbox-item:hover { background: rgba(0, 212, 255, 0.2); }
        .checkbox-item.selected { background: rgba(0, 212, 255, 0.3); border: 1px solid #00d4ff; }
        .checkbox-item input { accent-color: #00d4ff; }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-top: 15px;
        }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #7b2cbf); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-auto {
            padding: 8px 16px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-auto:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4); }
        .btn-auto:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .status-container { margin-top: 20px; display: none; }
        .status-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; }
        .status-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; }
        .status-pending { background: rgba(255,255,255,0.2); }
        .status-active { background: #00d4ff; animation: pulse 1.5s infinite; }
        .status-complete { background: #00c853; }
        .status-error { background: #ff5252; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .progress-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 15px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00d4ff, #7b2cbf); transition: width 0.5s ease; width: 0%; }

        .result-section, .error-section { display: none; margin-top: 20px; padding: 20px; border-radius: 12px; }
        .result-section { background: rgba(0, 200, 83, 0.1); border: 1px solid rgba(0, 200, 83, 0.3); }
        .result-section.show, .error-section.show { display: block; }
        .result-section h3 { color: #00c853; margin-bottom: 15px; }
        .error-section { background: rgba(255, 82, 82, 0.1); border: 1px solid rgba(255, 82, 82, 0.3); }
        .error-section h3 { color: #ff5252; margin-bottom: 10px; }
        .download-link {
            display: inline-flex; align-items: center; gap: 8px;
            color: #00d4ff; text-decoration: none; font-weight: 600;
            padding: 10px 20px; background: rgba(0, 212, 255, 0.1); border-radius: 8px;
        }
        .download-link:hover { background: rgba(0, 212, 255, 0.2); }

        .config-preview {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 0.8rem;
            max-height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #a0a0a0;
        }

        .instructions h3 { margin-bottom: 15px; font-size: 1.1rem; margin-top: 20px; }
        .instructions h3:first-child { margin-top: 0; }
        .instructions ol { padding-left: 20px; }
        .instructions li { margin-bottom: 8px; color: #a0a0a0; font-size: 0.9rem; }
        .instructions code { background: rgba(0, 212, 255, 0.2); padding: 2px 6px; border-radius: 4px; font-family: 'Consolas', monospace; color: #00d4ff; }

        footer { text-align: center; padding: 30px; color: #a0a0a0; margin-top: 40px; }
        footer a { color: #00d4ff; text-decoration: none; }

        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .row { display: flex; gap: 15px; }
        .row .form-group { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Automated Insight Engine</h1>
            <p>Transform your data into actionable insights with AI-powered analysis</p>
        </header>

        <div class="main-grid">
            <div class="card">
                <h2>üì§ Generate Report</h2>
                
                <div class="tabs">
                    <button class="tab active" data-tab="sample">üìä Sample Data</button>
                    <button class="tab" data-tab="csv">üìÅ Upload CSV</button>
                    <button class="tab" data-tab="sql">üóÑÔ∏è SQL Query</button>
                    <button class="tab" data-tab="config">‚öôÔ∏è Config File</button>
                </div>

                <div id="tab-sample" class="tab-content active">
                    <p style="color: #a0a0a0; margin-bottom: 15px;">Test with our included sample marketing data:</p>
                    <div class="config-preview" id="samplePreview"></div>
                </div>

                <div id="tab-csv" class="tab-content">
                    <div class="upload-area" id="csvUploadArea">
                        <div class="upload-icon">üìä</div>
                        <p>Drag & drop your <strong>CSV file</strong> or click to browse</p>
                        <div class="file-name" id="csvFileName"></div>
                    </div>
                    <input type="file" id="csvFileInput" accept=".csv">
                    
                    <div id="csvConfigSection" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">Configure Your Data</h4>
                            <button type="button" class="btn-auto" id="autoDetectBtn" onclick="autoDetectColumns()">
                                ü§ñ Auto-Detect with AI
                            </button>
                        </div>
                        <div id="aiAnalysisNote" style="display: none; padding: 10px; background: rgba(0, 212, 255, 0.1); border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem; color: #00d4ff;"></div>
                        <div class="form-group">
                            <label>Date Column</label>
                            <select id="csvDateCol" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label>Dimensions (categorical columns)</label>
                            <div id="csvDimensions" class="checkbox-group"></div>
                        </div>
                        <div class="form-group">
                            <label>Metrics (numeric columns)</label>
                            <div id="csvMetrics" class="checkbox-group"></div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label>Current Period Start</label>
                                <input type="date" id="csvCurrentStart" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Current Period End</label>
                                <input type="date" id="csvCurrentEnd" class="form-control">
                            </div>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label>Previous Period Start</label>
                                <input type="date" id="csvPrevStart" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Previous Period End</label>
                                <input type="date" id="csvPrevEnd" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-sql" class="tab-content">
                    <div class="form-group">
                        <label>Database Connection String</label>
                        <input type="text" id="sqlConnString" class="form-control" placeholder="postgresql://user:pass@host:5432/dbname">
                    </div>
                    <div class="form-group">
                        <label>SQL Query</label>
                        <textarea id="sqlQuery" class="form-control" rows="4" placeholder="SELECT date, campaign, geo, impressions, clicks, spend FROM marketing_data"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Date Column Name</label>
                        <input type="text" id="sqlDateCol" class="form-control" placeholder="date">
                    </div>
                    <div class="form-group">
                        <label>Dimensions (comma-separated)</label>
                        <input type="text" id="sqlDimensions" class="form-control" placeholder="campaign, geo">
                    </div>
                    <div class="form-group">
                        <label>Metrics (comma-separated)</label>
                        <input type="text" id="sqlMetrics" class="form-control" placeholder="impressions, clicks, spend">
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>Current Period Start</label>
                            <input type="date" id="sqlCurrentStart" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Current Period End</label>
                            <input type="date" id="sqlCurrentEnd" class="form-control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>Previous Period Start</label>
                            <input type="date" id="sqlPrevStart" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Previous Period End</label>
                            <input type="date" id="sqlPrevEnd" class="form-control">
                        </div>
                    </div>
                </div>

                <div id="tab-config" class="tab-content">
                    <div class="upload-area" id="configUploadArea">
                        <div class="upload-icon">üìÅ</div>
                        <p>Drag & drop your <strong>config.yaml</strong> or click to browse</p>
                        <div class="file-name" id="configFileName"></div>
                    </div>
                    <input type="file" id="configFileInput" accept=".yaml,.yml">
                </div>

                <button class="btn btn-primary" id="generateBtn" onclick="generateReport()">
                    <span id="btnText">üöÄ Generate Report</span>
                    <div class="spinner" id="btnSpinner"></div>
                </button>

                <div class="status-container" id="statusContainer">
                    <div class="status-item"><div class="status-icon status-pending" id="s1">1</div><span>Loading data sources...</span></div>
                    <div class="status-item"><div class="status-icon status-pending" id="s2">2</div><span>Computing metrics...</span></div>
                    <div class="status-item"><div class="status-icon status-pending" id="s3">3</div><span>Generating insights...</span></div>
                    <div class="status-item"><div class="status-icon status-pending" id="s4">4</div><span>Creating narrative with AI...</span></div>
                    <div class="status-item"><div class="status-icon status-pending" id="s5">5</div><span>Building PowerPoint...</span></div>
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                </div>

                <div class="result-section" id="resultSection">
                    <h3>‚úÖ Report Generated Successfully!</h3>
                    <a href="#" class="download-link" id="downloadLink" target="_blank">üì• Download PowerPoint Report</a>
                    
                    <!-- Dashboard Section -->
                    <div id="dashboardSection" style="margin-top: 20px; display: none;">
                        <div style="background: linear-gradient(135deg, #0052a3, #0096c7); border-radius: 12px; padding: 20px; margin-top: 15px;">
                            <h4 style="color: #fff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                üéØ Live Dashboard
                            </h4>
                            <p style="color: rgba(255,255,255,0.9); margin-bottom: 15px;">
                                Access your interactive dashboard with voice briefing by scanning the QR code in the PowerPoint, or click below:
                            </p>
                            <a href="#" id="dashboardLink" target="_blank" style="display: inline-block; background: #ff9900; color: #fff; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold;">
                                üîó Open Dashboard
                            </a>
                        </div>
                    </div>
                    
                    <!-- Audio Player Section -->
                    <div id="audioSection" style="margin-top: 20px; display: none;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.2);">
                            <h4 style="color: #00d4ff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                üéôÔ∏è Voice Briefing
                            </h4>
                            <div id="audioPlayer" style="display: flex; align-items: center; gap: 15px;">
                                <button id="playBtn" onclick="toggleAudio()" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #00d4ff, #7b2cbf); border: none; color: #fff; font-size: 20px; cursor: pointer;">
                                    ‚ñ∂Ô∏è
                                </button>
                                <div style="flex: 1;">
                                    <p id="audioStatus" style="color: #a0a0a0; margin-bottom: 8px;">Click to play summary</p>
                                    <div style="height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden;">
                                        <div id="audioProgress" style="height: 100%; background: linear-gradient(90deg, #00d4ff, #ff9900); width: 0%; transition: width 0.1s;"></div>
                                    </div>
                                </div>
                            </div>
                            <audio id="audioElement" style="display: none;"></audio>
                        </div>
                    </div>
                </div>

                <div class="error-section" id="errorSection">
                    <h3>‚ùå Error</h3>
                    <p id="errorMessage"></p>
                </div>
            </div>

            <div class="card">
                <h2>üìñ How to Use</h2>
                <div class="instructions">
                    <h3>Quick Start</h3>
                    <ol>
                        <li>Use <strong>Sample Data</strong> tab to test immediately</li>
                        <li>Or upload your own CSV/connect to SQL database</li>
                        <li>Configure columns and date ranges</li>
                        <li>Click <strong>Generate Report</strong></li>
                    </ol>

                    <h3>Data Sources</h3>
                    <ol>
                        <li><strong>CSV Upload</strong> - Upload any CSV file directly</li>
                        <li><strong>SQL Query</strong> - Connect to PostgreSQL, MySQL, SQLite</li>
                        <li><strong>Config File</strong> - Full YAML configuration</li>
                    </ol>

                    <h3>SQL Connection Examples</h3>
                    <div class="config-preview">PostgreSQL:
postgresql://user:pass@localhost:5432/mydb

MySQL:
mysql://user:pass@localhost:3306/mydb

SQLite:
sqlite:///path/to/database.db</div>
                </div>
            </div>
        </div>

        <footer>
            <p>Built with ‚ù§Ô∏è using FastAPI, Polars, DuckDB & Google Gemini</p>
            <p style="margin-top: 10px;"><a href="/docs">API Docs</a> | <a href="/redoc">ReDoc</a></p>
        </footer>
    </div>

    <script>
        let activeTab = 'sample';
        let csvFile = null;
        let csvColumns = [];
        let csvDelimiter = ',';
        let configFile = null;
        
        // Audio player state
        let currentAudioUrl = null;
        let currentVoiceScript = null;
        let isPlaying = false;
        let currentSegment = 0;
        let synth = window.speechSynthesis;
        
        function toggleAudio() {
            if (isPlaying) {
                stopAudio();
            } else {
                playAudio();
            }
        }
        
        function playAudio() {
            const playBtn = document.getElementById('playBtn');
            const audioElement = document.getElementById('audioElement');
            
            if (currentAudioUrl) {
                // Play MP3 file
                audioElement.play();
                isPlaying = true;
                playBtn.textContent = '‚è∏Ô∏è';
                document.getElementById('audioStatus').textContent = 'Playing...';
                
                audioElement.ontimeupdate = () => {
                    const progress = (audioElement.currentTime / audioElement.duration) * 100;
                    document.getElementById('audioProgress').style.width = progress + '%';
                };
                
                audioElement.onended = () => {
                    isPlaying = false;
                    playBtn.textContent = '‚ñ∂Ô∏è';
                    document.getElementById('audioStatus').textContent = 'Playback complete';
                    document.getElementById('audioProgress').style.width = '100%';
                };
            } else if (currentVoiceScript && currentVoiceScript.segments) {
                // Use browser TTS
                isPlaying = true;
                playBtn.textContent = '‚è∏Ô∏è';
                document.getElementById('audioStatus').textContent = 'Speaking...';
                speakSegments();
            } else if (currentVoiceScript && currentVoiceScript.full_text) {
                // Speak full text
                const utterance = new SpeechSynthesisUtterance(currentVoiceScript.full_text);
                utterance.rate = 0.9;
                isPlaying = true;
                playBtn.textContent = '‚è∏Ô∏è';
                
                utterance.onend = () => {
                    isPlaying = false;
                    playBtn.textContent = '‚ñ∂Ô∏è';
                    document.getElementById('audioStatus').textContent = 'Playback complete';
                    document.getElementById('audioProgress').style.width = '100%';
                };
                
                synth.speak(utterance);
            }
        }
        
        function stopAudio() {
            const playBtn = document.getElementById('playBtn');
            const audioElement = document.getElementById('audioElement');
            
            if (currentAudioUrl) {
                audioElement.pause();
            } else {
                synth.cancel();
            }
            
            isPlaying = false;
            currentSegment = 0;
            playBtn.textContent = '‚ñ∂Ô∏è';
            document.getElementById('audioStatus').textContent = 'Paused';
        }
        
        function speakSegments() {
            if (!isPlaying || !currentVoiceScript || currentSegment >= currentVoiceScript.segments.length) {
                isPlaying = false;
                document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è';
                document.getElementById('audioStatus').textContent = 'Playback complete';
                document.getElementById('audioProgress').style.width = '100%';
                currentSegment = 0;
                return;
            }
            
            const segment = currentVoiceScript.segments[currentSegment];
            const utterance = new SpeechSynthesisUtterance(segment.text);
            utterance.rate = 0.9;
            
            utterance.onend = () => {
                currentSegment++;
                const progress = (currentSegment / currentVoiceScript.segments.length) * 100;
                document.getElementById('audioProgress').style.width = progress + '%';
                
                setTimeout(() => {
                    if (isPlaying) speakSegments();
                }, segment.pause_after || 300);
            };
            
            synth.speak(utterance);
        }

        const sampleConfig = `dataset:
  primary_source: clicks
  sources:
    clicks:
      path: "data/clicks.csv"
      date_col: "date"
      dimensions: [campaign, geo]
      metrics: [impressions, clicks, spend]

derived_metrics:
  ctr: "clicks / impressions"
  cpc: "spend / clicks"

report:
  primary_date_col: date
  comparison:
    current_start: "2025-11-24"
    current_end: "2025-11-30"
    previous_start: "2025-11-17"
    previous_end: "2025-11-23"
  primary_dims: [campaign, geo]
  kpi_priority: [ctr, cpc, impressions, clicks]`;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('samplePreview').textContent = sampleConfig;
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tabId).classList.add('active');
                    activeTab = tabId;
                });
            });

            const csvArea = document.getElementById('csvUploadArea');
            const csvInput = document.getElementById('csvFileInput');
            csvArea.addEventListener('click', () => csvInput.click());
            csvInput.addEventListener('change', (e) => handleCsvUpload(e.target.files[0]));
            csvArea.addEventListener('dragover', (e) => { e.preventDefault(); csvArea.style.borderColor = '#00d4ff'; });
            csvArea.addEventListener('dragleave', () => { csvArea.style.borderColor = 'rgba(255,255,255,0.3)'; });
            csvArea.addEventListener('drop', (e) => { e.preventDefault(); csvArea.style.borderColor = 'rgba(255,255,255,0.3)'; handleCsvUpload(e.dataTransfer.files[0]); });

            const configArea = document.getElementById('configUploadArea');
            const configInput = document.getElementById('configFileInput');
            configArea.addEventListener('click', () => configInput.click());
            configInput.addEventListener('change', (e) => handleConfigUpload(e.target.files[0]));
            configArea.addEventListener('dragover', (e) => { e.preventDefault(); configArea.style.borderColor = '#00d4ff'; });
            configArea.addEventListener('dragleave', () => { configArea.style.borderColor = 'rgba(255,255,255,0.3)'; });
            configArea.addEventListener('drop', (e) => { e.preventDefault(); configArea.style.borderColor = 'rgba(255,255,255,0.3)'; handleConfigUpload(e.dataTransfer.files[0]); });

            setDefaultDates('sql');
        });

        function handleCsvUpload(file) {
            if (!file || !file.name.endsWith('.csv')) {
                alert('Please upload a CSV file');
                return;
            }
            csvFile = file;
            document.getElementById('csvFileName').textContent = 'üìÑ ' + file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(l => l.trim());
                if (lines.length > 0) {
                    const firstLine = lines[0];
                    csvDelimiter = ',';
                    const semicolonCount = (firstLine.match(/;/g) || []).length;
                    const commaCount = (firstLine.match(/,/g) || []).length;
                    const tabCount = (firstLine.match(/\t/g) || []).length;
                    
                    if (semicolonCount > commaCount && semicolonCount > tabCount) csvDelimiter = ';';
                    else if (tabCount > commaCount && tabCount > semicolonCount) csvDelimiter = '\t';
                    
                    csvColumns = firstLine.split(csvDelimiter).map(c => c.trim().replace(/^["']|["']$/g, ''));
                    populateCsvOptions();
                    document.getElementById('csvConfigSection').style.display = 'block';
                    setDefaultDates('csv');
                    
                    // Auto-trigger AI detection
                    autoDetectColumns();
                }
            };
            reader.readAsText(file);
        }

        async function autoDetectColumns() {
            if (!csvFile) {
                alert('Please upload a CSV file first');
                return;
            }
            
            const btn = document.getElementById('autoDetectBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Analyzing...';
            
            try {
                const formData = new FormData();
                formData.append('csv_file', csvFile);
                
                const response = await fetch('/analyze-csv', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Analysis failed');
                }
                
                const result = await response.json();
                
                // Apply the AI suggestions
                // Set date column
                const dateSelect = document.getElementById('csvDateCol');
                for (let opt of dateSelect.options) {
                    if (opt.value === result.date_column) {
                        opt.selected = true;
                        break;
                    }
                }
                
                // Clear existing selections
                document.querySelectorAll('#csvDimensions input, #csvMetrics input').forEach(cb => {
                    cb.checked = false;
                    cb.parentElement.classList.remove('selected');
                });
                
                // Set dimensions
                result.dimensions.forEach(dim => {
                    const cb = document.querySelector(`#csvDimensions input[value="${dim}"]`);
                    if (cb) {
                        cb.checked = true;
                        cb.parentElement.classList.add('selected');
                    }
                });
                
                // Set metrics
                result.metrics.forEach(metric => {
                    const cb = document.querySelector(`#csvMetrics input[value="${metric}"]`);
                    if (cb) {
                        cb.checked = true;
                        cb.parentElement.classList.add('selected');
                    }
                });
                
                // Set date ranges
                if (result.suggested_date_range) {
                    document.getElementById('csvCurrentStart').value = result.suggested_date_range.current_start;
                    document.getElementById('csvCurrentEnd').value = result.suggested_date_range.current_end;
                    document.getElementById('csvPrevStart').value = result.suggested_date_range.previous_start;
                    document.getElementById('csvPrevEnd').value = result.suggested_date_range.previous_end;
                }
                
                // Show analysis notes
                if (result.analysis_notes) {
                    const noteDiv = document.getElementById('aiAnalysisNote');
                    noteDiv.textContent = 'ü§ñ ' + result.analysis_notes;
                    noteDiv.style.display = 'block';
                }
                
                btn.innerHTML = '‚úÖ Done!';
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
                
            } catch (error) {
                alert('AI Analysis failed: ' + error.message);
                btn.innerHTML = originalText;
            } finally {
                btn.disabled = false;
            }
        }

        function populateCsvOptions() {
            const dateSelect = document.getElementById('csvDateCol');
            dateSelect.innerHTML = '<option value="">-- Select --</option>' + 
                csvColumns.map(c => `<option value="${c}" ${c.toLowerCase().includes('date') || c.toLowerCase().startsWith('dt_') ? 'selected' : ''}>${c}</option>`).join('');

            const dimDiv = document.getElementById('csvDimensions');
            dimDiv.innerHTML = csvColumns.map(c => 
                `<label class="checkbox-item"><input type="checkbox" value="${c}"> ${c}</label>`
            ).join('');

            const metricDiv = document.getElementById('csvMetrics');
            metricDiv.innerHTML = csvColumns.map(c => 
                `<label class="checkbox-item"><input type="checkbox" value="${c}"> ${c}</label>`
            ).join('');

            document.querySelectorAll('.checkbox-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        const cb = item.querySelector('input');
                        cb.checked = !cb.checked;
                    }
                    item.classList.toggle('selected', item.querySelector('input').checked);
                });
            });
        }

        function handleConfigUpload(file) {
            if (!file || (!file.name.endsWith('.yaml') && !file.name.endsWith('.yml'))) {
                alert('Please upload a YAML file');
                return;
            }
            configFile = file;
            document.getElementById('configFileName').textContent = 'üìÑ ' + file.name;
        }

        function setDefaultDates(prefix) {
            const today = new Date();
            const fmt = d => d.toISOString().split('T')[0];
            document.getElementById(prefix + 'CurrentEnd').value = fmt(today);
            document.getElementById(prefix + 'CurrentStart').value = fmt(new Date(today - 7*24*60*60*1000));
            document.getElementById(prefix + 'PrevEnd').value = fmt(new Date(today - 8*24*60*60*1000));
            document.getElementById(prefix + 'PrevStart').value = fmt(new Date(today - 15*24*60*60*1000));
        }

        function buildYamlConfig(source, sourceConfig, prefix) {
            const dims = sourceConfig.dimensions || [];
            const metrics = sourceConfig.metrics || [];
            
            let sourceYaml = '';
            if (sourceConfig.type === 'csv') {
                sourceYaml = `      type: csv
      path: "${sourceConfig.path}"`;
            } else if (sourceConfig.type === 'sql') {
                sourceYaml = `      type: sql
      connection_string: "${sourceConfig.connection_string}"
      query: "${sourceConfig.query.replace(/\n/g, ' ').replace(/"/g, '\\"')}"`;
            }

            return `dataset:
  primary_source: ${source}
  sources:
    ${source}:
${sourceYaml}
      date_col: "${sourceConfig.date_col}"
      dimensions:
${dims.map(d => `        - ${d}`).join('\n')}
      metrics:
${metrics.map(m => `        - ${m}`).join('\n')}

derived_metrics: {}

report:
  primary_date_col: ${sourceConfig.date_col}
  comparison:
    current_start: "${document.getElementById(prefix + 'CurrentStart').value}"
    current_end: "${document.getElementById(prefix + 'CurrentEnd').value}"
    previous_start: "${document.getElementById(prefix + 'PrevStart').value}"
    previous_end: "${document.getElementById(prefix + 'PrevEnd').value}"
  primary_dims:
${dims.map(d => `    - ${d}`).join('\n')}
  kpi_priority:
${metrics.map(m => `    - ${m}`).join('\n')}`;
        }

        async function generateReport() {
            const btn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            const spinner = document.getElementById('btnSpinner');
            const statusContainer = document.getElementById('statusContainer');
            const resultSection = document.getElementById('resultSection');
            const errorSection = document.getElementById('errorSection');

            resultSection.classList.remove('show');
            errorSection.classList.remove('show');
            statusContainer.style.display = 'block';
            btn.disabled = true;
            btnText.textContent = 'Generating...';
            spinner.style.display = 'block';

            for (let i = 1; i <= 5; i++) {
                const el = document.getElementById('s' + i);
                el.className = 'status-icon status-pending';
                el.textContent = i;
            }
            document.getElementById('progressFill').style.width = '0%';

            let step = 0;
            const progress = setInterval(() => {
                if (step < 5) {
                    document.getElementById('s' + (step + 1)).className = 'status-icon status-active';
                    document.getElementById('s' + (step + 1)).textContent = '‚ãØ';
                    if (step > 0) {
                        document.getElementById('s' + step).className = 'status-icon status-complete';
                        document.getElementById('s' + step).textContent = '‚úì';
                    }
                    document.getElementById('progressFill').style.width = ((step + 1) * 20) + '%';
                    step++;
                }
            }, 800);

            try {
                const formData = new FormData();

                if (activeTab === 'sample') {
                    formData.append('config_file', new Blob([sampleConfig], {type: 'application/x-yaml'}), 'config.yaml');
                } 
                else if (activeTab === 'csv') {
                    if (!csvFile) throw new Error('Please upload a CSV file');
                    const dateCol = document.getElementById('csvDateCol').value;
                    const dims = Array.from(document.querySelectorAll('#csvDimensions input:checked')).map(i => i.value);
                    const metrics = Array.from(document.querySelectorAll('#csvMetrics input:checked')).map(i => i.value);
                    if (!dateCol || dims.length === 0 || metrics.length === 0) {
                        throw new Error('Please select date column, at least one dimension, and at least one metric');
                    }
                    const yaml = buildYamlConfig('uploaded_data', { 
                        type: 'csv', 
                        path: 'uploaded.csv', 
                        date_col: dateCol, 
                        dimensions: dims, 
                        metrics: metrics 
                    }, 'csv');
                    formData.append('config_file', new Blob([yaml], {type: 'application/x-yaml'}), 'config.yaml');
                    formData.append('csv_file', csvFile);
                }
                else if (activeTab === 'sql') {
                    const connString = document.getElementById('sqlConnString').value;
                    const query = document.getElementById('sqlQuery').value;
                    const dateCol = document.getElementById('sqlDateCol').value;
                    const dims = document.getElementById('sqlDimensions').value.split(',').map(s => s.trim()).filter(s => s);
                    const metrics = document.getElementById('sqlMetrics').value.split(',').map(s => s.trim()).filter(s => s);
                    if (!connString || !query || !dateCol || dims.length === 0 || metrics.length === 0) {
                        throw new Error('Please fill in all SQL connection fields');
                    }
                    const yaml = buildYamlConfig('sql_source', { 
                        type: 'sql', 
                        connection_string: connString, 
                        query: query, 
                        date_col: dateCol, 
                        dimensions: dims, 
                        metrics: metrics 
                    }, 'sql');
                    formData.append('config_file', new Blob([yaml], {type: 'application/x-yaml'}), 'config.yaml');
                }
                else if (activeTab === 'config') {
                    if (!configFile) throw new Error('Please upload a config file');
                    formData.append('config_file', configFile);
                }

                const response = await fetch('/generate-report', { method: 'POST', body: formData });
                clearInterval(progress);

                if (response.ok) {
                    const data = await response.json();
                    for (let i = 1; i <= 5; i++) {
                        document.getElementById('s' + i).className = 'status-icon status-complete';
                        document.getElementById('s' + i).textContent = '‚úì';
                    }
                    document.getElementById('progressFill').style.width = '100%';
                    document.getElementById('downloadLink').href = data.download_url;
                    document.getElementById('downloadLink').textContent = 'üì• Download ' + data.download_url.split('/').pop();
                    
                    // Show dashboard link if available
                    if (data.dashboard_url) {
                        document.getElementById('dashboardLink').href = data.dashboard_url;
                        document.getElementById('dashboardSection').style.display = 'block';
                    } else {
                        document.getElementById('dashboardSection').style.display = 'none';
                    }
                    
                    // Setup audio player
                    if (data.audio_url) {
                        currentAudioUrl = data.audio_url;
                        currentVoiceScript = null;
                        document.getElementById('audioElement').src = data.audio_url;
                        document.getElementById('audioStatus').textContent = 'AI voice summary ready';
                        document.getElementById('audioSection').style.display = 'block';
                    } else if (data.voice_script) {
                        currentAudioUrl = null;
                        currentVoiceScript = data.voice_script;
                        document.getElementById('audioStatus').textContent = 'Voice summary ready (browser TTS)';
                        document.getElementById('audioSection').style.display = 'block';
                    } else {
                        document.getElementById('audioSection').style.display = 'none';
                    }
                    
                    resultSection.classList.add('show');
                } else {
                    const err = await response.json();
                    throw new Error(err.detail || 'Unknown error');
                }
            } catch (error) {
                clearInterval(progress);
                document.getElementById('s' + Math.min(step + 1, 5)).className = 'status-icon status-error';
                document.getElementById('s' + Math.min(step + 1, 5)).textContent = '‚úó';
                document.getElementById('errorMessage').textContent = error.message;
                errorSection.classList.add('show');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üöÄ Generate Report';
                spinner.style.display = 'none';
            }
        }
    </script>
</body>
</html>
